#!/bin/bash

# Simple static malware analysis script
# Usage: ./static_scan.sh <file>

set -e

if [ -z "$1" ]; then
  echo "Usage: $0 <file>"
  exit 1
fi

FILE="$1"

if [ ! -f "$FILE" ]; then
  echo "[!] File not found: $FILE"
  exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
YARA_DIR="$SCRIPT_DIR/yara_rules"
HASH_DB="$SCRIPT_DIR/sample_hashes.txt"
REPORT_DIR="$SCRIPT_DIR/reports"

mkdir -p "$REPORT_DIR"

BASENAME="$(basename "$FILE")"
REPORT="$REPORT_DIR/${BASENAME}_static_report.txt"

echo "==========================================" > "$REPORT"
echo " Static Analysis Report" >> "$REPORT"
echo " File: $FILE" >> "$REPORT"
echo " Generated: $(date)" >> "$REPORT"
echo "==========================================" >> "$REPORT"

echo -e "\n[FILE INFO]" >> "$REPORT"
file "$FILE" >> "$REPORT" 2>&1

echo -e "\n[HASHES]" >> "$REPORT"
MD5_HASH=$(md5sum "$FILE" | awk '{print $1}')
SHA256_HASH=$(sha256sum "$FILE" | awk '{print $1}')
echo "MD5:    $MD5_HASH" >> "$REPORT"
echo "SHA256: $SHA256_HASH" >> "$REPORT"

echo -e "\n[HASH REPUTATION]" >> "$REPORT"
if [ -f "$HASH_DB" ]; then
  MATCH_LABEL=$(awk -F',' -v m1="$MD5_HASH" -v m2="$SHA256_HASH" '
    $2 == m1 || $3 == m2 {print $1}
  ' "$HASH_DB")

  if [ -n "$MATCH_LABEL" ]; then
    echo "KNOWN SAMPLE: $MATCH_LABEL" >> "$REPORT"
  else
    echo "No match in local hash database." >> "$REPORT"
  fi
else
  echo "Hash database not found: $HASH_DB" >> "$REPORT"
fi

echo -e "\n[TOP 40 STRINGS]" >> "$REPORT"
strings "$FILE" | head -n 40 >> "$REPORT" 2>&1

echo -e "\n[YARA RESULTS]" >> "$REPORT"
if [ -d "$YARA_DIR" ] && ls "$YARA_DIR"/*.yar >/dev/null 2>&1; then
  yara -r "$YARA_DIR" "$FILE" >> "$REPORT" 2>&1 || echo "YARA scan completed with warnings." >> "$REPORT"
else
  echo "No YARA rules found in $YARA_DIR" >> "$REPORT"
fi

echo -e "\n[CLAMAV SCAN]" >> "$REPORT"
if command -v clamscan >/dev/null 2>&1; then
  clamscan "$FILE" >> "$REPORT" 2>&1
else
  echo "clamscan not installed or not in PATH." >> "$REPORT"
fi

echo -e "\n[SUMMARY]" >> "$REPORT"
echo "Static analysis completed. Report saved to:" >> "$REPORT"
echo "$REPORT" >> "$REPORT"

echo "[+] Static analysis complete. Report: $REPORT"

