# setup/auditd_setup.md

## 1. Objective

Configure **auditd** on the Ubuntu malware lab VM to capture:

* Command execution (including `sudo`, `bash`, `sh`)
* File and directory changes in the malware lab paths
* Permission changes (`chmod`, `chown`)
* Persistence attempts (cron, symlinks, config abuse)

These logs will later be forwarded to **Splunk** for SOC-style detection.

---

## 2. Install and Enable auditd

```bash
sudo apt update
sudo apt install auditd audispd-plugins -y
```

Enable and start the service:

```bash
sudo systemctl enable auditd
sudo systemctl start auditd
sudo systemctl status auditd
```

You should see `active (running)` in the status.

---

## 3. Create a Dedicated Rules File

We keep lab rules in a separate file for clarity.

```bash
sudo nano /etc/audit/rules.d/malware_lab.rules
```

Paste the following rules (adjust paths if your username or directories differ):

```bash
###########################
# Malware Lab Audit Rules #
###########################

# 1) Track execution of key binaries (command and script execution)
#   - MITRE: T1059 (Command and Scripting Interpreter)
-a always,exit -F arch=b64 -S execve -k exec_monitor

# 2) Track changes in the malware lab directory (dynamic-analysis, test_samples, etc.)
#   Replace "/opt/malwarelab" with your actual lab path if different
-w /opt/malwarelab -p rwa -k malware_lab

# 3) Track permission changes (chmod/chown)
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -k perm_change
-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -k perm_change

# 4) Track cron-related persistence (if used in the lab)
-w /etc/cron.d/ -p rwa -k cron_persist
-w /etc/crontab -p rwa -k cron_persist

# 5) Track snap / Firefox-related paths for the fake ransomware chain (example)
-w /home/kali/snap/firefox/ -p rwa -k firefox_chain
-w /home/kali/.config/ibus/ -p rwa -k firefox_chain
-w /run/user/1000/snap.firefox/ -p rwa -k firefox_chain
```

Save and exit.

---

## 4. Apply the Rules

Reload auditd rules:

```bash
sudo augenrules --load
```

Verify that your rules are loaded:

```bash
sudo auditctl -l
```

You should see lines with keys like `exec_monitor`, `malware_lab`, `perm_change`, `cron_persist`, `firefox_chain`.

---

## 5. Generate Test Activity

Run a few commands to verify logging:

```bash
ls /opt/malwarelab
sudo chmod 700 /opt/malwarelab
sudo touch /etc/cron.d/persist_test
```

Check recent events by key:

```bash
sudo ausearch -k exec_monitor | tail -n 20
sudo ausearch -k malware_lab | tail -n 20
sudo ausearch -k cron_persist | tail -n 20
```

If you see output, auditd is capturing the right telemetry.

---

## 6. Log File Location

The main audit log file is:

```bash
/var/log/audit/audit.log
```

This file will later be **monitored by Splunk Universal Forwarder** and sent to the SIEM.

---

## 7. Troubleshooting

* If `auditd` is not running:

  ```bash
  sudo systemctl restart auditd
  sudo journalctl -u auditd --no-pager | tail -n 50
  ```
* If rules do not appear with `auditctl -l`, re-run:

  ```bash
  sudo augenrules --load
  ```
* Ensure the rules file has the correct extension (`.rules`) and is inside `/etc/audit/rules.d/`.

---

# setup/splunk_forwarder_setup.md

## 1. Objective

Install and configure the **Splunk Universal Forwarder** on the Ubuntu malware lab VM to:

* Collect `auditd` logs
* Collect system logs (`/var/log/syslog`, `/var/log/auth.log`)
* Forward them securely to the Splunk indexer / Splunk Enterprise instance used in the SOC lab.

---

## 2. Prerequisites

* A running **Splunk Enterprise** or **Splunk Free** instance (usually on a separate VM or host).
* IP/hostname and receiving port of the Splunk server (default often `9997`).
* Ubuntu malware lab VM with internet access (for initial download) or `.deb` package copied manually.

---

## 3. Install Splunk Universal Forwarder

1. Download the Linux `.deb` installer for **Splunk Universal Forwarder** from Splunk's official site.

   * Example filename (this will change with versions):

     ```
     splunkforwarder-9.x.x-linux-2.6-amd64.deb
     ```

2. Copy it to your Ubuntu malware lab VM, then install:

   ```bash
   cd ~/Downloads
   sudo dpkg -i splunkforwarder-*.deb
   ```

3. Accept the license and set the admin credentials on first start:

   ```bash
   sudo /opt/splunkforwarder/bin/splunk start --accept-license
   ```

   If prompted, set a username/password (use something simple for lab, but note it down).

---

## 4. Configure Indexer (Output) Settings

Tell the forwarder where to send logs.

Create/edit:

```bash
sudo mkdir -p /opt/splunkforwarder/etc/system/local
sudo nano /opt/splunkforwarder/etc/system/local/outputs.conf
```

Example configuration:

```conf
[tcpout]
defaultGroup = default-autolb-group

[tcpout:default-autolb-group]
server = 192.168.56.10:9997

[tcpout-server://192.168.56.10:9997]
```

* Replace `192.168.56.10` with your **Splunk server IP**.
* Replace `9997` with your actual **Splunk receiving port** if different.

Restart the forwarder to apply changes:

```bash
sudo /opt/splunkforwarder/bin/splunk restart
```

---

## 5. Configure Inputs (What to Monitor)

Create/edit:

```bash
sudo nano /opt/splunkforwarder/etc/system/local/inputs.conf
```

Add the following:

```conf
# === Auditd logs ===
[monitor:///var/log/audit/audit.log]
index = soc_malware_lab
sourcetype = linux:audit
_disabled = false

# === Syslog (general system events) ===
[monitor:///var/log/syslog]
index = soc_malware_lab
sourcetype = syslog
_disabled = false

# === Authentication logs (sudo, ssh, etc.) ===
[monitor:///var/log/auth.log]
index = soc_malware_lab
sourcetype = linux:auth
_disabled = false
```

> Make sure the index name (`soc_malware_lab`) exists on the Splunk server, or change it to an index that does.

Restart the forwarder:

```bash
sudo /opt/splunkforwarder/bin/splunk restart
```

---

## 6. Verify Data in Splunk

On the Splunk server UI:

1. Go to **Search & Reporting**.
2. Run a search like:

   ```
   index="soc_malware_lab" sourcetype="linux:audit"
   ```
3. Generate some activity on the Ubuntu VM (e.g., `sudo ls /root`, run `fake_ransom.sh`).
4. Confirm that events appear with fields for `COMMAND`, `exe`, `key`, etc.

If no data appears:

* Check forwarder logs:

  ```bash
  sudo /opt/splunkforwarder/bin/splunk list forward-server
  sudo tail -n 50 /opt/splunkforwarder/var/log/splunk/splunkd.log
  ```
* Check that Splunk indexer is **listening on the specified port** and that firewalls are not blocking traffic.

---

## 7. Useful Forwarder Commands

```bash
# Start / stop forwarder
sudo /opt/splunkforwarder/bin/splunk start
sudo /opt/splunkforwarder/bin/splunk stop

# Check connection to indexer
sudo /opt/splunkforwarder/bin/splunk list forward-server

# Enable boot-start
sudo /opt/splunkforwarder/bin/splunk enable boot-start
```

This completes the Splunk Universal Forwarder setup for the malware analysis lab.

---

# setup/network_isolation.md

## 1. Objective

Design a network configuration that allows:

* Safe execution of **malware or ransomware simulations**
* Log forwarding to Splunk
* **No risk** of the malware escaping to the internet or production network

This guide assumes:

* **Kali Linux** as the host or main analysis machine
* **Ubuntu** as the malware lab VM
* Optionally, a separate **Splunk server VM**
* VirtualBox is used as the hypervisor (concepts similar for VMware).

---

## 2. Network Design Overview

We use **two types of networks**:

1. **Host-Only / Internal Network**

   * Used between: Kali ↔ Ubuntu ↔ Splunk
   * No direct internet access
   * Contains all potentially malicious traffic.

2. **NAT (Optional, Controlled)**

   * Only for systems that require temporary internet access (e.g., to download packages).
   * The **malware VM should NOT use this during active malware tests**.

---

## 3. Recommended Topology

* Kali (Host / Attacker / Analyst)

  * Adapter 1: NAT (for updates, tooling, browsing docs)
  * Adapter 2: Host-Only / Internal (to talk to Ubuntu and Splunk)

* Ubuntu (Malware Lab)

  * Adapter 1: Host-Only / Internal **only**
  * No direct NAT/Bridged during malware execution

* Splunk Server (if separate)

  * Adapter 1: Host-Only / Internal

This ensures that:

* All malware-related traffic is trapped on the **isolated lab network**.
* Only Kali has outbound internet and can act as a management / pivot box if really needed.

---

## 4. Configure Host-Only / Internal Network in VirtualBox

1. Open **VirtualBox** → `File` → `Tools` → `Network Manager`.
2. Create a new **Host-Only Network** (e.g., `vboxnet0`).
3. Assign an IP range, for example:

   * `192.168.56.1` for the host side
   * DHCP optional, or you can assign static IPs on guests.

For each VM:

### Kali VM

* Adapter 1: `NAT`
* Adapter 2: `Host-Only Adapter` → `vboxnet0`

### Ubuntu Malware Lab VM

* Adapter 1: `Host-Only Adapter` → `vboxnet0`

### Splunk VM

* Adapter 1: `Host-Only Adapter` → `vboxnet0`

---

## 5. Assign Static IPs (Recommended)

On each VM, set static IPs on the host-only interface.

Example (Ubuntu):

```bash
sudo nano /etc/netplan/01-netcfg.yaml
```

Example configuration:

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s8:
      dhcp4: no
      addresses: [192.168.56.20/24]
      gateway4: 192.168.56.1
      nameservers:
        addresses: [8.8.8.8]
```

Apply:

```bash
sudo netplan apply
```

Set corresponding IPs for Kali (e.g., `192.168.56.10`) and Splunk (e.g., `192.168.56.30`).

---

## 6. Blocking Internet From Malware Lab (Optional Hardening)

If you want **zero internet** from the Ubuntu lab VM, you can:

1. Ensure it only has the **Host-Only** adapter.
2. Additionally, block forwarding on Kali using `iptables` or `ufw` (if Kali is routing).

Example (on Kali, block forwarding from lab subnet to internet):

```bash
sudo iptables -A FORWARD -s 192.168.56.0/24 -j DROP
```

This ensures the lab network cannot route out even if misconfigured.

---

## 7. Test Connectivity

From Ubuntu (malware lab VM):

```bash
ping 192.168.56.10   # Kali
ping 192.168.56.30   # Splunk (if separate)
```

From Kali:

```bash
ping 192.168.56.20   # Ubuntu
```

You should see **successful ping inside the lab**, but **no internet access** from the Ubuntu VM during malware runs.

---

## 8. Operational Guidelines

* Only enable internet (e.g., temporary NAT adapter) when:

  * Installing packages
  * Updating OS/tools
* Disable or detach the NAT adapter before:

  * Executing any malware samples
  * Running ransomware simulations
* Keep **all SOC telemetry, Splunk, and attack tools on the host-only network**.

This design keeps the lab realistic while **strongly isolating** malicious activity from your home / production network.
